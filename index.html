<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GrowWithMe</title>
    <style>
      body {
        background: linear-gradient(to right, #007BFF, #00C6FF);
        color: white;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        padding: 20px;
        margin: 0;
      }
      h1, h2 {
        text-align: center;
        text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.3);
      }
      form, #dashboard {
        background-color: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 10px;
        max-width: 400px;
        margin: 20px auto;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
      }
      input, button {
        width: 100%;
        margin: 10px 0;
        padding: 10px;
        border-radius: 6px;
        border: none;
        font-size: 16px;
      }
      input {
        background: white;
        color: #333;
      }
      button {
        background-color: #ffffff;
        color: #007BFF;
        font-weight: bold;
        transition: background-color 0.3s;
      }
      button:hover {
        background-color: #e0e0e0;
      }
      #dashboard p {
        font-size: 18px;
        margin: 10px 0;
      }
      #referral-link {
        font-weight: bold;
        word-wrap: break-word;
      }
      .toggle-btn {
        font-size: 14px;
        color: #fff;
        background: none;
        text-align: center;
        border: none;
        cursor: pointer;
        display: block;
        margin-top: -5px;
        text-decoration: underline;
      }
    </style>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        updateDoc,
        increment,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAi-FWKpvax2nF-VA6WwCh716Xuy8EuV3I",
        authDomain: "growwithme-97a46.firebaseapp.com",
        projectId: "growwithme-97a46",
        storageBucket: "growwithme-97a46.appspot.com",
        messagingSenderId: "415554479474",
        appId: "1:415554479474:web:206b46ba60e131e6eaa9eb",
        measurementId: "G-S3BBS3NLL9"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth();
      const db = getFirestore();

      const signupForm = document.getElementById("signup-form");
      const loginForm = document.getElementById("login-form");
      const dashboard = document.getElementById("dashboard");
      const referralLink = document.getElementById("referral-link");
      const invitedCount = document.getElementById("invited-count");
      const referralEarnings = document.getElementById("referral-earnings");
      const toggleSignup = document.getElementById("toggle-signup");

      const referralCode = new URLSearchParams(window.location.search).get("ref");

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          signupForm.style.display = "none";
          loginForm.style.display = "none";
          dashboard.style.display = "block";

          const userRef = doc(db, "users", user.uid);
          const userSnap = await getDoc(userRef);

          if (!userSnap.exists()) {
            await setDoc(userRef, {
              invitedBy: referralCode || null,
              invitedCount: 0,
              earnings: 0,
            });

            if (referralCode) {
              const inviterSnap = await getDoc(doc(db, "users", referralCode));
              if (inviterSnap.exists()) {
                await updateDoc(doc(db, "users", referralCode), {
                  invitedCount: increment(1),
                  earnings: increment(10),
                });
              }
            }
          }

          referralLink.innerText = `${window.location.origin}/?ref=${user.uid}`;

          const freshSnap = await getDoc(userRef);
          invitedCount.innerText = freshSnap.data().invitedCount || 0;
          referralEarnings.innerText = "₹" + (freshSnap.data().earnings || 0);
        }
      });

      signupForm.onsubmit = async (e) => {
        e.preventDefault();
        const email = signupForm["email"].value;
        const password = signupForm["password"].value;
        await createUserWithEmailAndPassword(auth, email, password);
      };

      loginForm.onsubmit = async (e) => {
        e.preventDefault();
        const email = loginForm["email"].value;
        const password = loginForm["password"].value;
        await signInWithEmailAndPassword(auth, email, password);
      };

      toggleSignup.onclick = () => {
        loginForm.style.display = "none";
        signupForm.style.display = "block";
      }
    </script>
  </head>
  <body>
    <h1>GrowWithMe</h1>

    <form id="login-form">
      <h2>Login</h2>
      <input type="email" name="email" placeholder="Email" required /><br />
      <input type="password" name="password" placeholder="Password" required /><br />
      <button type="submit">Login</button>
      <button type="button" class="toggle-btn" id="toggle-signup">Don't have an account? Sign up here</button>
    </form>

    <form id="signup-form" style="display: none">
      <h2>Sign Up</h2>
      <input type="email" name="email" placeholder="Email" required /><br />
      <input type="password" name="password" placeholder="Password" required /><br />
      <button type="submit">Sign Up</button>
    </form>

    <div id="dashboard" style="display:none">
      <h2>Dashboard</h2>
      <p><strong>Your referral link:</strong><br><span id="referral-link"></span></p>
      <p><strong>Total Invited:</strong> <span id="invited-count">0</span></p>
      <p><strong>Total Earnings:</strong> <span id="referral-earnings">₹0</span></p>
    </div>
  </body>
</html>
